<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
	<style>
		.tabset > input[type="radio"] {
		  position: absolute;
		  left: -200vw;
		}

		.tabset .tab-panel {
		  display: none;
		}

		.tabset > input:first-child:checked ~ .tab-panels > .tab-panel:first-child,
		.tabset > input:nth-child(3):checked ~ .tab-panels > .tab-panel:nth-child(2),
		.tabset > input:nth-child(5):checked ~ .tab-panels > .tab-panel:nth-child(3),
		.tabset > input:nth-child(7):checked ~ .tab-panels > .tab-panel:nth-child(4),
		.tabset > input:nth-child(9):checked ~ .tab-panels > .tab-panel:nth-child(5),
		.tabset > input:nth-child(11):checked ~ .tab-panels > .tab-panel:nth-child(6) {
		  display: block;
		}

		/*
		 Styling
		*/
		body {
		  font: 16px/1.5em "Overpass", "Open Sans", Helvetica, sans-serif;
		  color: #333;
		  font-weight: 300;
		}

		.tabset > label {
		  position: relative;
		  display: inline-block;
		  padding: 10px 10px 15px;
		  border: 1px solid transparent;
		  border-bottom: 0;
		  cursor: pointer;
		  font-weight: 600;
		}

		.tabset > label::after {
		  content: "";
		  position: absolute;
		  left: 15px;
		  bottom: 10px;
		  width: 22px;
		  height: 4px;
		  background: #8d8d8d;
		}

		.tabset > label:hover,
		.tabset > input:focus + label {
		  color: #06c;
		}

		.tabset > label:hover::after,
		.tabset > input:focus + label::after,
		.tabset > input:checked + label::after {
		  background: #06c;
		}

		.tabset > input:checked + label {
		  border-color: #ccc;
		  border-bottom: 1px solid #fff;
		  margin-bottom: -1px;
		}

		.tab-panel {
		  padding: 20px 10px;
		  border-top: 1px solid #ccc;
		}

	</style>
	<script>
		function parsePath(p){
			var res=p.toUpperCase()
			for (i in process.env)
			res=res.replace("%"+i+"%",process.env[i])
			return res
		}
		function remember()
		{
			document.querySelectorAll(".remember").forEach(function(e){
				if (!e.inited)
				{
					e.addEventListener('input', save)
					load([e])
				}
				e.inited=true
			})			
		}		
		function save()
		{
			document.querySelectorAll(".remember").forEach(function(e){				
				if (e.type=="checkbox")
					localStorage.setItem(e.id,e.checked)
				else if (e.type=="radio")
					localStorage.setItem(e.id,e.checked)
				else if (e.type=="select-one")
					localStorage.setItem(e.id,e.selectedIndex)
				else
					localStorage.setItem(e.id,e.value)
			})			
		}
		function load(e)
		{
			if (e==null)
				e=document.querySelectorAll(".remember")			
			e.forEach(function(e){				
				if (!(e.id in localStorage) || localStorage.getItem(e.id)=="") return
				if (e.type=="checkbox" )
					e.checked=localStorage.getItem(e.id)=="true"	
				else if (e.type=="radio" )
					e.checked=localStorage.getItem(e.id)=="true"					
				else if (e.type=="select-one")
					e.selectedIndex=parseInt(localStorage.getItem(e.id))
				else
					e.value=localStorage.getItem(e.id)
			})			
		}
	</script>
  </head>
  <body>	
	<div class="tabset">
		<!-- Tab 1 -->
		<input type="radio" name="tabset" id="tab1" aria-controls="tabs-1" class="remember"  checked>
		<label for="tab1">鼠标灵敏度</label>
		<!-- Tab 2 -->
		<input type="radio" name="tabset" id="tab2" aria-controls="tabs-2" class="remember">
		<label for="tab2">击杀提示</label>
 		<!-- Tab 3 -->
		<input type="radio" name="tabset" id="tab3" aria-controls="tabs-3" class="remember" >
		<label for="tab3">关于</label> 
		<div class="tab-panels">
			<!-- ====鼠标灵敏度调整========================================================== -->
			<section id="tabs-1" class="tab-panel">		
				<p>此功能通过调整配置文件来统一不同游戏的灵敏度</p>
				360°鼠标行程(英尺)<input id="travel" class="remember" value=12.087115384615384 onchange="r6drawchart()"> </input>(=鼠标行程(像素)/DPI,如无需求请勿手工改变此值)
				<canvas id="mschart" width=400 height=200 ></canvas>
				<input id="zoom" class="remember" value=5 hidden > </input>
				<button onclick="document.querySelector('#zoom').value=parseFloat(document.querySelector('#zoom').value)-1;save();r6drawchart()">放大</button>
				<button onclick="document.querySelector('#zoom').value=parseFloat(document.querySelector('#zoom').value)+1;save();r6drawchart()">缩小</button>
				(拖动结点调整灵敏度。结点会自动吸附其他足够接近的结点)<br>
				<div style="   border: 1px solid #000;margin: 10px 0px;">
					<p>彩虹六号</p>
					<table>
						<tr>
							<td>XFactorAiming</td>
							<td>
								<input id="XFactorAiming" class="remember"  value="0.02" onchange="r6drawchart()" />
							</td>
						</tr>
						<tr>
							<td>灵敏度</td>
							<td>
								<input id="r6ms1" class="remember" value="13" onchange="r6drawchart()"> </input>
								<input id="r6ms2" class="remember" value="84" onchange="r6drawchart()"> </input>
							</td>
						</tr>
						<tr>
							<td>DPI</td>
							<td>
								<input id="r6mdpi" class="remember"  value="400" onchange="r6drawchart()" />
							</td>
						</tr>												
					</table>
					<button id="r6calibration">以此为基准</button>
					
				</div>									
				<div style="   border: 1px solid #000;margin: 10px 0px;">
					<p>逃离塔科夫</p>
					<button id="eftcalibration">以此为基准</button><br>
					<label>游戏配置文件目录</label>
					<input id="eftconfig"class="remember" style="width:100%"value="%USERPROFILE%\Documents\Escape from Tarkov" />
					<br>
					<table>
						<tr>
							<td>灵敏度</td>
							<td>
								<input id="eftms1" class="remember" value="0.17" onchange="r6drawchart()"> </input>
								<input id="eftms2" class="remember" value="0.17" onchange="r6drawchart()"> </input>
							</td>
						</tr>
						<tr>
							<td>DPI</td>
							<td>
								<input id="eftdpi" class="remember"  value="1600" onchange="r6drawchart()" />
							</td>
						</tr>
					</table>
					<input id="efttd" type="checkbox" class="remember" >抵消装备带来的转向惩罚</input><label id="efttdl"></label>
					<br>	
					头盔:<select id="efthm" class="remember"></select><br>
					弹挂:<select id="eftrg" class="remember"></select><br>
					防弹衣:<select id="eftve" class="remember"></select><br>					
					<img id="efthmE"/><img id="eftrgE"/><img id="eftveE"/><br>
										
					<button onclick="eftread()">读取设置</button>
					<button onclick="eftwrite()">写入设置</button>(重启生效)<br>
					<script src="eft/gears.js"> </script>
					<script>										
						helmat.forEach(t=>{
							var e=document.createElement("option")
							e.innerHTML=t.name
							document.getElementById("efthm").append(e)
						})
						vests.forEach(t=>{
							var e=document.createElement("option")
							e.innerHTML=t.name
							document.getElementById("eftve").append(e)
						})
						rigs.forEach(t=>{
							var e=document.createElement("option")
							e.innerHTML=t.name
							document.getElementById("eftrg").append(e)
						})
						document.getElementById("efthm").onclick=eftgear
						document.getElementById("eftve").onclick=eftgear					
						document.getElementById("eftrg").onclick=eftgear
						function getgearturn()
						{
							return	 (helmat[document.getElementById("efthm").selectedIndex].turnspeed ||0)
									+(vests[document.getElementById("eftve").selectedIndex].turnspeed  ||0)
									+(rigs[document.getElementById("eftrg").selectedIndex].turnspeed   ||0);
						}	
						function eftgear()
						{
							document.getElementById("efthmE").src=""
							document.getElementById("eftveE").src=""
							document.getElementById("eftrgE").src=""
							document.getElementById("efthmE").src=helmat[document.getElementById("efthm").selectedIndex].url
							document.getElementById("eftveE").src=vests[document.getElementById("eftve").selectedIndex].url
							document.getElementById("eftrgE").src=rigs[document.getElementById("eftrg").selectedIndex].url
							console.log(getgearturn())
							document.getElementById("efttdl").innerHTML="("+100*getgearturn()+"%)"						
						}
						remember()
						eftgear()
						function eftread(notload=false)
						{
							var fs=require("fs")
							try{
								var json=fs.readFileSync(parsePath(document.querySelector("#eftconfig").value)+"\\shared.ini")
							}catch(e)
							{
								alert("塔科夫配置文件读取错误")
							}
							if (!json || json.length==0)  return alert("塔科夫配置文件路径不存在")
							json=JSON.parse(""+json)
							if (!notload)
							{
								document.querySelector("#eftms1").value=json["bak_MouseSensitivity"] || json["MouseSensitivity"]						
								document.querySelector("#eftms2").value=json["MouseAimingSensitivity"]						
								save()
								r6drawchart()
							}
							return json
						}
						function eftwrite()
						{
							var json=eftread(true)						
							json["MouseSensitivity"]=parseFloat(document.querySelector("#eftms1").value)
							json["MouseAimingSensitivity"]=parseFloat(document.querySelector("#eftms2").value)		
							
							json["bak_MouseSensitivity"]=json["MouseSensitivity"]
							if (document.getElementById("efttd").checked)
								json["MouseSensitivity"]/=(1+getgearturn())
							
							try{
								fs.writeFileSync(parsePath(document.querySelector("#eftconfig").value)+"\\shared.ini",JSON.stringify(json,null,2))
							}catch(e)
							{
								alert("塔科夫配置文件读取错误")
							}						
						}
					</script>
				</div>
				
				<div style="   border: 1px solid #000;margin: 10px 0px;">
					<p>战地V</p>
					<button id="bf5calibration">以此为基准</button><br>
					<label>游戏配置文件目录</label>
					<input id="bf5config"class="remember" style="width:100%"value="%USERPROFILE%\Documents\Battlefield V\settings" />					
					<br>
					<table>
						<tr>
							<td>GstInput.MouseSensitivity</td>
							<td>								
								<input id="bf5ms" class="remember" value=0.00312370707489 onchange="r6drawchart()"> </input>
							</td>
						</tr>
						<tr>
							<td>1.25倍镜系数</td>
							<td>
								<input id="bf5ms_1_25" class="remember" value=1.00 onchange="r6drawchart()"> </input><!-- GstInput.SoldierZoomSensitivity1x25 -->
							</td>
						</tr>
						<tr>
							<td>1.50倍镜系数</td>
							<td>
								<input id="bf5ms_1_50" class="remember" value=1.00 onchange="r6drawchart()"> </input><!-- GstInput.SoldierZoomSensitivity1x50 -->
							</td>
						</tr>
						<tr>
							<td>2倍镜系数</td>
							<td>
								<input id="bf5ms_2" class="remember" value=1.00 onchange="r6drawchart()"> </input><!-- GstInput.SoldierZoomSensitivity2x00 -->
							</td>
						</tr>
						<tr>
							<td>3倍镜系数</td>
							<td>
								<input id="bf5ms_3" class="remember" value=1.00 onchange="r6drawchart()"> </input><!-- GstInput.SoldierZoomSensitivity3x00 -->
							</td>
						</tr>
						<tr>
							<td>6倍镜系数</td>
							<td>
								<input id="bf5ms_6" class="remember" value=1.00 onchange="r6drawchart()"> </input><!-- GstInput.SoldierZoomSensitivity6x00 -->								
							</td>
						</tr>						

						<tr>
							<td>DPI</td>
							<td>
								<input id="bf5dpi" class="remember"  value="1600" onchange="r6drawchart()" />
							</td>
						</tr>
						
					</table>
					
					<button id="bf5read">读取设置</button>
					<button id="bf5write">写入设置</button>(重启生效)<br>
					<script>
					(function(){
						function read(){
							var path=parsePath(document.querySelector("#bf5config").value+"\\PROFSAVE_profile_synced")
							console.log(path)
							var text=""+fs.readFileSync(path)
							var json={order:[]}
							text=text.split(/\r?\n/)
							text.forEach(function(e){
								e=e.split(/\s+/)
								json[e[0]]=e[1]								
								json.order.push(e[0])
							})										
							return json							
						}
						document.querySelector("#bf5read").onclick=function(){
							var json=read(true);
							document.querySelector("#bf5ms").value=json["GstInput.MouseSensitivity"]
							document.querySelector("#bf5ms_1_25").value=json["GstInput.SoldierZoomSensitivity1x25"]
							document.querySelector("#bf5ms_1_50").value=json["GstInput.SoldierZoomSensitivity1x50"]
							document.querySelector("#bf5ms_2").value=json["GstInput.SoldierZoomSensitivity2x00"]
							document.querySelector("#bf5ms_3").value=json["GstInput.SoldierZoomSensitivity3x00"]
							document.querySelector("#bf5ms_6").value=json["GstInput.SoldierZoomSensitivity6x00"]
							save()							
							r6drawchart()
						}
						document.querySelector("#bf5write").onclick=function(){
							var json=read(true);
							json["GstInput.MouseSensitivity"]=parseFloat(document.querySelector("#bf5ms").value)
							json["GstInput.SoldierZoomSensitivity1x25"]=parseFloat(document.querySelector("#bf5ms_1_25").value)
							json["GstInput.SoldierZoomSensitivity1x50"]=parseFloat(document.querySelector("#bf5ms_1_50").value)
							json["GstInput.SoldierZoomSensitivity2x00"]=parseFloat(document.querySelector("#bf5ms_2").value)
							json["GstInput.SoldierZoomSensitivity3x00"]=parseFloat(document.querySelector("#bf5ms_3").value)
							json["GstInput.SoldierZoomSensitivity6x00"]=parseFloat(document.querySelector("#bf5ms_6").value)
							var res=""
							json.order.forEach(t=>res+=t+" "+json[t]+"\n")
							var path=parsePath(document.querySelector("#bf5config").value+"\\PROFSAVE_profile_synced")
							fs.writeFileSync(path,res)
						}
					})();
					</script>
					
				</div>
				
				<script src="chart/Chart.min.js" > </script>
				<style href="chart/Chart.min.css" > </style>	
				<script src="d3.v5.min.js"></script>	
				<script src="chart/hammerjs@2.0.8"></script>
				<script src="chart/chartjs-plugin-zoom@0.7.4"></script>				
				<script>
				remember()
				Chart.defaults.global.elements.line.fill = false;			
				let nerdamer = require('nerdamer');require('nerdamer/Algebra.js');require('nerdamer/Calculus.js');require('nerdamer/Solve.js');				
				nerdamer.set('SOLUTIONS_AS_OBJECT', true);
				function which(f,name,x)
				{
					for (var i=0;i<f.length;++i)
						if (f[i][name]==x)
							return f[i]
					return undefined
				}
				var chartInstance				
				function r6drawchart(){//setTimeout(function(){		
					var zoom=document.querySelector('#zoom').value
					var travel=parseFloat(document.querySelector('#travel').value)
					////////////////////////////////////////////////									
					var options = {
						type: 'scatter',  						
						data: {
							datasets: [
							//{showLine: true,label: "Rasd",data: [{x: 0,y: 5}, {x: 5.2,y: 10}, {x: 8,y: 5}, {x: 15,y: 0}]}
							]
						},
						options: {
							responsive: true,
							maintainAspectRatio: true,
							scales: {
								xAxes: [{ scaleLabel: {display: true,labelString: '实际放大倍率(16:9,60HFOV)'},ticks: {beginAtZero: true,max: Math.max(1,zoom)},type: 'linear',position: 'bottom'}],
								yAxes: [{ scaleLabel: {display: true,labelString: '灵敏度减缓倍率'},ticks: {beginAtZero: true,max: Math.max(1,zoom),min: 0}}]
								
							},
							elements: {line: {tension: 0}}
							//,pan: {enabled: true,mode: 'x'}
							,zoom: {enabled: true,mode: 'xy'}
							,tooltips: {
								callbacks: {
									afterLabel: function(tooltipItem, data) {
										var res=""
										var dt=data.datasets[tooltipItem.datasetIndex]										
										res+=""+dt.label+" "+dt.data[tooltipItem.index].label
										return res
									}
									,footer:function(ti,ob)
									{
										var res=""
										var x=parseFloat(ti[0].xLabel)
										var y=parseFloat(ti[0].yLabel)
										var block={
											func:function(datasetIndex,index){return datasetIndex+","+index}
											,test:function(datasetIndex,index){return this[ this.func(datasetIndex,index) ] }
											,set:function(datasetIndex,index){this[ this.func(datasetIndex,index) ]=true;this.points.push({datasetIndex:datasetIndex,index:index}) }
											,points:[]
			
										};
										ti.forEach(t=>{block.set(t.datasetIndex,t.index)})										
										var arr=claculateY(x,block)
										//console.log(JSON.stringify(arr,null,2))
										var ar=[]
										arr.forEach((json)=>{
											if (Math.abs(y-json.y)>0.1) return
											//if (json.cat==0 && ti[0].datasetIndex==json.dti && json.pi==ti[0].index) return
											d=(json.y-y)
											ar.push([Math.abs(d),json.label+"    |    误差 "+d.toFixed(10)+"\n"])											
										})
										ar.sort((a,b)=>a[0]-b[0])										
										ar.forEach(t=>res+=(t[1]))										
										//console.log(res)
										return res
									}
								}
							}
						}
					};
					function upload(arg)
					{
						for (var i in arg)
						{
							var e=document.querySelector("#"+i);if (!e) continue							
							e.value=arg[i]
						}	
						save()
					}
					function ans(a){var res={};a.forEach(function(a){res[a[0]]=a[1]});return res}
					function infinitY(data){						
						var x1,x2,y1,y2
						x1=data[data.length-3].x
						y1=data[data.length-3].y
						x2=data[data.length-2].x
						y2=data[data.length-2].y
						var that=data[data.length-1]
						that.x=100
						that.y=y1+(y2-y1)/(x2-x1)*(that.x-x1)
						
					}
					function reverseset()
					{
						this.y=this.set(null)						
					}
					//逃离塔科夫
					(function(){
						var arg={
							 eftms1:parseFloat( document.querySelector("#eftms1").value )
							,eftms2:parseFloat( document.querySelector("#eftms2").value )
							,eftdpi:parseInt( document.querySelector("#eftdpi").value )
							,basems:0.1
						}
						document.querySelector("#eftcalibration").onclick=function()
						{					
							document.querySelector('#travel').value=travel*data[1].y
							save()
							r6drawchart()
						}
						function update()
						{							
							this.y=this.mtd/(arg[this.ms]/arg.basems)
							this.y=this.y/arg.eftdpi/travel
						}
						function set(newy)
						{
							newy=newy*arg.eftdpi*travel
							arg[this.ms]=this.mtd*arg.basems/newy						
							upload(arg)
						}
						var data= [	
								{x:0,y:0}
								,{x: 1,mtd:28800,x_named:1,ms:"eftms1",label:"腰射",update:update,set:set}
								,{x: 1.0*96/68,mtd:44300,x_named:1,ms:"eftms2",label:"机瞄",update:update,set:set}
								,{x: 1.0*96/68,mtd:48000,x_named:1,ms:"eftms2",label:"全息",update:update,set:set}
								,{x: 1.0*205/68,mtd:57600,x_named:2,ms:"eftms2",label:"Monstr. 2",update:update,set:set}
								,{x: 1.0*397/79,mtd:96000,x_named:3.5,ms:"eftms2",label:"PU 3.5x",update:update,set:set}
								,{x: 1.0*455/68,mtd:144000,x_named:4,ms:"eftms2",label:"x4(HAMR,DR1/4xFDE,PSO 1 4x24",update:update,set:set}
							]
						data.push({update:infinitY.bind(null,data),label:"∞"})
						data.forEach(function(e){
							e.update=e.update || function(){};e.set=e.set || function(){}
							e.update()
						})
						options.data.datasets.push({label: "Escape From Tarkov",data: data,showLine: true,borderColor: "#8e5ea2"})						
					})();
					//战地5
					(function(){
						var arg={
							 a:0.00636618283677
							,b:0.00003183091418							
							,bf5ms:parseFloat( document.querySelector("#bf5ms").value )														
							,bf5ms_1_25:parseFloat( document.querySelector("#bf5ms_1_25").value )
							,bf5ms_1_50:parseFloat( document.querySelector("#bf5ms_1_50").value )
							,bf5ms_2:parseFloat( document.querySelector("#bf5ms_2").value )
							,bf5ms_3:parseFloat( document.querySelector("#bf5ms_3").value )
							,bf5ms_6:parseFloat( document.querySelector("#bf5ms_6").value )					
							,bf5dpi:parseInt( document.querySelector("#bf5dpi").value )							
							,mtd_1:31416
						}
						document.querySelector("#bf5calibration").onclick=function()
						{					
							document.querySelector('#travel').value=travel*data[1].y
							save()
							r6drawchart()
						}						
						var t=nerdamer.solveEquations(["1/31416=a*0+b","1/7854=a*0.015+b","1/(4834*4)=a*x+b"])
						arg.a=t.a
						arg.b=t.b						
						function update()
						{
							this.y=1/(arg.a*arg.bf5ms+arg.b)/arg[this.ms]*(this.mtd/arg.mtd_1)				
							this.y= (this.y/arg.bf5dpi) / travel
						}
												
						function set(newy){
							newy=newy* travel *arg.bf5dpi																				
							arg[this.ms]=1/(newy*(arg.a*arg.bf5ms+arg.b)/(this.mtd/arg.mtd_1))
							upload(arg)
						}
						//,update:function(){ this.y=(arg.a*arg.bf5ms*(this.mtd/31416)*arg[this.ms]+arg.b)*(arg.bf5dpi/400)*4834     } 
						//,set:function(newy){ arg[this.ms]=(newy/4834/(arg.bf5dpi/400)-arg.b)/arg.a/(this.mtd/31416)/arg.bf5ms;upload(arg);  }

						var data= [	
								{x:0,y:0}
								,{x_named:1.00,x: 1,label:"腰射/1倍镜",mtd:arg.mtd_1
									,update:function(){this.y=1/(arg.a*arg.bf5ms+arg.b);this.y= (this.y/arg.bf5dpi) / travel}
									,set:function(newy){newy=newy* travel *arg.bf5dpi;arg.bf5ms=(1/newy-arg.b)/arg.a;upload(arg)}
								}
								,{x_named:1.25,x: 1.0*44/35,label:"1.25倍镜" ,mtd:38228,ms:"bf5ms_1_25",update:update,set:set}
								,{x: 1.0*273/183,x_named:1.5,label:"1.5倍镜" ,mtd:45140,ms:"bf5ms_1_50",update:update,set:set}
								,{x: 1.0*428/215,x_named:2,label:"2倍镜" ,mtd:59164,ms:"bf5ms_2",update:update,set:set}
								,{x: 1.0*105/36,x_named:3,label:"3倍镜" ,mtd:87756,ms:"bf5ms_3",update:update,set:set}								
								,{x: 1.0*209/34,x_named:6,label:"6倍镜" ,mtd:174528,ms:"bf5ms_6",update:update,set:set
									//,update:function(){this.y=(this.mtd/31456)/arg[this.ms]/(arg.bf5dpi/400)/4834/(arg.a*arg.bf5ms+arg.b)  } 
									//,set:function(newy){ arg[this.ms]=Math.min(2,Math.max(0,(this.mtd/31456)/newy/(arg.bf5dpi/400)/4834/(arg.a*arg.bf5ms+arg.b)));upload(arg);  }
								}
							]						
						data.push({update:infinitY.bind(null,data),label:"∞"})
						data.forEach(function(e){
							e.update=e.update || function(){};e.set=e.set || function(){}
							e.update()
						})						
						options.data.datasets.push({label: "BattleField V",data: data,showLine: true,borderColor: "#00ff00"})						
					})();
					//彩虹六号										
					(function(){
						var arg={
							XFactorAiming:parseFloat( document.querySelector("#XFactorAiming").value ),
							r6ms1:parseInt( document.querySelector("#r6ms1").value ),
							r6ms2:parseInt( document.querySelector("#r6ms2").value ),
							r6mdpi:parseInt( document.querySelector("#r6mdpi").value ),
							ACOG_1_50_360_pixel:1257.06 //这是ACOG测量后转换成腰射的鼠标行程
						}
						document.querySelector("#r6calibration").onclick=function()
						{					
							document.querySelector('#travel').value=travel*data[1].y
							save()
							r6drawchart()
						}
						function update(){
							this.y=arg.ACOG_1_50_360_pixel / 0.02 / arg.r6ms1 / Math.min(Math.max(arg.r6ms2 *arg.XFactorAiming *this.OpticModifier, 0), 1)							
							this.y= (this.y/arg.r6mdpi) / travel
						}
						function set(newy){
							newy=newy* travel *arg.r6mdpi
							arg.r6ms2=arg.ACOG_1_50_360_pixel / 0.02 / arg.r6ms1 / (arg.XFactorAiming *this.OpticModifier)/newy
							arg.r6ms2=Math.max(1,Math.min(100,Math.round(arg.r6ms2)))
							upload(arg)
						}
						var data= [	
								{x:0,y:0,label:"原点"}
								,{label:"腰射",x: 1,OpticModifier:1,update:update,set:set}
								//,update:function(){this.y=travel / arg.ACOG_1_50_360_pixel *0.02*arg.r6ms1*arg.r6mdpi      },set:function(newy){arg.r6ms1=newy / travel * arg.ACOG_1_50_360_pixel /0.02/arg.r6mdpi;upload(arg) }}
								,{label:"机瞄/全息/红点/反射",x:1/0.90,OpticModifier:0.60,update:update,set:set}
								,{label:"ACOG"               ,x:1/0.35,OpticModifier:0.35,update:update,set:set}
								,{label:"OTs-03"             ,x:1/0.30,OpticModifier:0.30,update:update,set:set}								
							]
						data.push({update:infinitY.bind(null,data),label:"∞"})
						data.forEach(function(e){
							e.update=e.update || function(){};e.set=e.set || function(){}
							e.update()
						})						
						options.data.datasets.push({label: "Rainbow Six Siege",data: data,showLine: true,borderColor: "#3e95cd"})						
					})();
					//////////////////////////////////////
					if (chartInstance) chartInstance.destroy();
					chartInstance = new Chart(document.getElementById('mschart').getContext('2d'), options);
					d3.select(chartInstance.chart.canvas).call(		d3.drag().container(chartInstance.chart.canvas).on('start', getElement).on('drag', updateData)   );

					var element, scale, datasetIndex, index, value
					var nearbypoint=[]
					function getElement () {
						var e = d3.event.sourceEvent
						element = chartInstance.getElementAtEvent(e)[0]		
						if (!element) {scale=null;return }
						scale = element['_yScale'].id
						//获取吸附结点列表
						datasetIndex = element['_datasetIndex']
						index = element['_index']
						value = chartInstance.scales[scale].getValueForPixel(e.layerY)						
						var data=chartInstance.data.datasets[datasetIndex].data		
						var x=data[index].x
						var block={
							func:function(datasetIndex,index){return datasetIndex+","+index}
							,test:function(datasetIndex,index){return this[ this.func(datasetIndex,index) ] }
							,set:function(datasetIndex,index){this[ this.func(datasetIndex,index) ]=true;this.points.push({datasetIndex:datasetIndex,index:index}) }
							,points:[]

						};
						block.set(datasetIndex,index)											
						nearbypoint=claculateY(x,block)
						console.log(nearbypoint)
					}
					function claculateY(X,block)
					{						
						var res=[]
						for (var i=0;i<10;i+=0.5)
							res.push({y:i,label:""+i+"倍",strong:0.8})
						chartInstance.data.datasets.forEach((dt,dti)=>{
							if (dt._meta[0] && dt._meta[0].hidden) return 
							dt.data.forEach((p1,p1i)=>{if(block.test(dti,p1i)) return							
								//计算相近点
								if (p1.label)
									res.push({y:p1.y,label:"(临近)"+dt.label+" "+p1.label,cat:0,dti:dti,pi:p1i,strong:0.3})													
								dt.data.forEach((p2,p2i)=>{if(block.test(dti,p2i)) return			
									if (p1i>=p2i || p2i==0) return 									
									if (Math.abs(p2.x-p1.x)<1E-6) return									
									//计算相近斜率
									var blocky={}
									block.points.forEach(function(p){
										qi=p.index-1
										var tt=chartInstance.data.datasets[p.datasetIndex].data
										while (qi>=0 && Math.abs(tt[qi].x-tt[p.index].x)<1E-2) qi-=1;
										if (qi<0) return
										q=chartInstance.data.datasets[p.datasetIndex].data[qi]
										if (!q) return
										a=(p2.y-p1.y)/(p2.x-p1.x)										
										if (p1.label && p2.label && p2.label!="∞")
										{
											y=q.y+a*(X-q.x)											
											res.push({y:y,label:"(斜率)"+" ["+q.label+" ➡ "+tt[p.index].label+"]  "+dt.label+" "+p1.label+" ➡ "+p2.label,cat:1})
											blocky[y]=true
										}
									})
									//计算插值
									if (p1.x<=X && X<=p2.x && p1i+1==p2i)
									{
										y=p1.y+(p2.y-p1.y)/(p2.x-p1.x)*(X-p1.x)
										res.push({y:y,label:"(插值)"+dt.label+" "+p1.label+" ➡ "+p2.label,strong:0.5})
									}
									
								})
							})
						})
						res.sort((a,b)=>1000*(a.cat-b.cat)+a.y-b.y)
						return res					
					}						
					function updateData () {
						if (!element) return
						var e = d3.event.sourceEvent
						datasetIndex = element['_datasetIndex']
						index = element['_index']
						value = chartInstance.scales[scale].getValueForPixel(e.layerY)
						var data=chartInstance.data.datasets[datasetIndex].data		
						//////////////////
						//实现吸附功能						
						var x=data[index].x
						var nv={y:1}
						function fun(t,value)
						{
							if (t.strong==undefined) t.strong=1
							return t.strong*Math.abs(t.y-value)
						}
						nearbypoint.forEach(function(t){
							if ( nv==null || fun(nv,value)>fun(t,value)  )
								nv=t
						})								
						console.log(nv,value-nv.y)
						if (nv!=null && Math.abs(nv.y-value)<0.02) value=nv.y
						//////////////////
																
						data[index].set(value)
						data.forEach(e=>e.update())
						chartInstance.update(0)
					}
					
					
					
				////////////////////////////////////////////////
				}//},1)
				setTimeout(r6drawchart,1000)
				</script>
			</section>
			<!-- ===击杀提示=========================================================== -->
			<section id="tabs-2" class="tab-panel">	

				<p>此功能的原理是统计精彩击杀视频的数量来进行击杀提示，<b>需要玩家启用Nvidia Highlight并在游戏内部开启相应选项</b></p>	
				<label>Nvidia Highlight目录</label>
				<input  class="remember"  id="nh" style="width:100%"value="Z:\Highlights\Escape From Tarkov" />
				击杀记录：
				<div  id="killConfirmList"  ></div>
				简易教程:<br>
				<img src="image/1.png" width="50%"></img><br>
				<img src="image/2.png" width="50%"></img><br>
				上边图中是N卡精彩时刻的总文件夹，我们需要选中存放塔科夫的文件夹，名称一般是“Escape From Tarkov”<br>
				因此在这里我的路径为“Z:\Highlights\Escape From Tarkov”<br>
				<script>
					var tabs2mp3 = new Audio("kill_confirmed_bo2.mp3");		
					const fs=require("fs")
					const chokidar = require('chokidar');
					var watcher=null
					var tabsmp3play=function(){};
					var tabsmp3stop=function(){};
					(function(){
						var playing=false;
						var count=0,target=0;
						tabsmp3play=function(notcount=false){
							if(!notcount)
								target+=1							
							if (! playing)
							{
								playing=true
								tabs2mp3.play();
								return
							}							
						}
						tabsmp3stop=function()
						{
							//tabs2mp3.stop();
							count=target=0
						}
						tabs2mp3.addEventListener("ended", function(){
							playing=false							
							count+=1
							if (count<target)
								tabsmp3play(true)
						}, false);
					})()
					function killwatcher()
					{
						if (watcher) watcher.close()
						var p=document.querySelector("#nh").value
						watcher=chokidar.watch(p,{ignoreInitial: true})
							.on("add",function(path){
								tabsmp3play()
								document.querySelector("#killConfirmList").innerHTML+=path+"<br>"
							})
							.on("unlink",function(){
								tabsmp3stop()
								document.querySelector("#killConfirmList").innerHTML=""
							})
					}
					setTimeout(killwatcher,1)
					/*
					(function(){
						const fs=require("fs")					
						var tabs2old=Array(100).length
						var tabs2mp3 = new Audio("kill_confirmed_bo2.mp3");						
						function tabs2()
						{
							var p=document.querySelector("#nh").value
							fs.readdir(p,function(err,dir){
								if (err) return setTimeout(tabs2,1000)
								if (tabs2old.length!=dir.length)
								{
									console.log(dir)
									if (tabs2old.length<dir.length)
										tabs2mp3.play();
									document.querySelector("#tabs2p").innerHTML=dir.join("<br>")
								}
								tabs2old=dir
								setTimeout(tabs2,1000)
							})
							
						}
						tabs2()
					})()
					*/
					
				</script>
			</section>
			<section id="tabs-3" class="tab-panel">	
				wywzxxz 制作<br>
				仓库地址：https://github.com/wywzxxz/EFTkillNotification<br>
			</section>
		</div>
		<script>
		remember()		
		</script>
  </body>
</html>
